\section{Type Soundness}
\label{sec:ilcproofs}

We first define syntax for process and channel typings, which each map a kind of
identifier (process name or channel name) to its associated type:

\begin{grammar}
    Process pool typings
    %(maps process names to their types)
    & $\PrTy$
    &$\bnfas$& $\emptyctxt \bnfalt \PrTy,\ProcNm{p} A \bnfalt \PrTy,\ProcNm{p} X$
    \\
    Channel pool typings
    %(maps channel names to their types)
    & $\ChTy$
    &$\bnfas$& $\emptyctxt \bnfalt \ChTy,c:\tyRd{S} \bnfalt \ChTy,c:\tyWr{S}$
\end{grammar}

%\subsection{Configuration Typings}

Using the syntax above, we define configuration typing as a straightforward extension
of single-process typing, given in \Secref{subsec:types}:\smallskip

\judgbox{\JCty{\StTy}{\ChTy}{C}{\PrTy}}{Configuration $C$ is well-typed.}
\begin{mathpar}
\Infer{empty}
{ 
  %\StTy ; \ChTy |- \Store : \StTy
}
{\JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\emptyProcs}}{\cdot}}
\and
\Infer{cons}
{ \ChTy |- e : U\\
\JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\Procs}}{\PrTy}}
{ \JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\Procs,p:e}}{\PrTy,(p:U)}}
%\and
%\Infer{cons}
%{\Delta; \Gamma |- e : U\\
%\JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\Procs}}{\PrTy}}
%{ \JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\Procs,p:e}}{\PrTy,(p:U)}}
\end{mathpar}

\subsection{Progress}
\label{subsec:label}

Progress for the functional fragment of ILC (local progress) is fairly
standard. We follow the usual recipe, except that we give a special definition
of local process termination:\smallskip

\judgbox{\Lterm{e}}{Expression $e$ is locally terminated.}
\begin{mathpar}
\Infer{val}
{ }
{\Lterm{v}}
\and  
\Infer{rdterm}
{ }
{\Lterm{E[\eLetRd{c}{x}{e}]}}
\and
%\Infer{chterm}
%{\Lterm{e_1} \\ \Lterm{e_2}}
%{\Lterm{E[\eChoice{e_1}{e_2}]}}
\Infer{chterm}
{ }
{\Lterm{E[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}]}}
\and
\Infer{wrterm}
{ }
{\Lterm{E[\eWr{v}{c}]}}
\end{mathpar}
In other words, $\Lterm{e}$ holds when $e$ is a value, is reading (either as a
standalone read or an external choice), or is writing.

\begin{lemma}[Local Progress]
  If $|- e : U$, then either $\Lterm{e}$
  or there exists $e'$ such that $e -> e'$.
  \begin{proof}
    By structural induction on the derivation of $|- e : U$.
  \end{proof}
\end{lemma}

To state progress on configurations, we give a special definition of ``program
termination'' that permits deadlocks:\smallskip

\judgbox{\JCterm{C}}{Configuration $C$ is terminated.}
\begin{mathpar}
\Infer{Cterm}
{\forall (p:e) \in \pi.~\Lterm{e}\\\\
\textrm{RdChans}(\pi) = \Sigma_1 \\ \textrm{WrChans}(\pi) = \Sigma_2\\\\
\{ (c_1,c_2) \mid c_1 \in \Sigma_1, c_2 \in \Sigma_2, c_2 \leadsto c_1\} = \varnothing}
{\JCterm{\Config{\Names}{}{\Procs}}}
\end{mathpar}
\begin{align*}
  \textrm{RdChans}(\emptyProcs) &= \emptyctxt
  &\textrm{WrChans}(\emptyProcs) &= \emptyctxt
  \\
  \textrm{RdChans}(\pi, p:E[\eLetRd{c}{x}{e}]) &= \textrm{RdChans}(\pi),c
  &\textrm{WrChans}(\pi, p:E[\eLetRd{c}{x}{e}]) &= \textrm{WrChans}(\pi)
  \\
  \textrm{RdChans}(\pi, p:E[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}]) &=
  \textrm{RdChans}(\pi),c_1,c_2
  &\textrm{WrChans}(\pi, p:E[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}]) &= \textrm{WrChans}(\pi)  
  \\
  \textrm{RdChans}(\pi, p:E[\eWr{v}{c}]) &= \textrm{RdChans}(\pi)
  &\textrm{WrChans}(\pi, p:E[\eWr{v}{c}]) &= \textrm{WrChans}(\pi),c
  \\
  \textrm{RdChans}(\pi, p:v) &= \textrm{RdChans}(\pi)
  &\textrm{WrChans}(\pi, p:v) &= \textrm{WrChans}(\pi)
\end{align*}
In other words, $\JCterm{C}$ holds when either:
\begin{enumerate}
 \item $C$ is fully normal: Every process in~$C$ is normalized (consists of a
   value).
 \item $C$ is (at least partially) deadlocked: 
   Some (possibly empty) portion of $C$ is normal, and there exists one or more
   reading processes in $C$, or there exists one or more writing processes in
   $C$, however, no read-write channel pair~$(c_1,c_2)$ exists such that $c_2 \leadsto
   c_1$.
\end{enumerate}

%\begin{lemma}[Non-progress]
%If $\JCty{\StTy}{\ChTy}{C}{\PrTy}$ and $\JCterm{C}$, then there does not exist
%$C'$ such that $\JCred{C}{C'}$.
%\begin{proof}
%    By structural induction on the derivation of $\JCty{\StTy}{\ChTy}{C}{\PrTy}$.
%\end{proof}
%\end{lemma}
%\begin{lemma}[Non-progress]
%For all configurations $C$,
%channel typings~$\ChTy$,
%and process typings~$\PrTy$,
%%
%if $\JCty{\StTy}{\ChTy}{C}{\PrTy}$
%and $\JCterm{C}$,
%then there does not exist $C'$ such that $\JCred{C}{C'}$.
%\begin{proof}
%    By structural induction on the derivation of $\JCty{\StTy}{\ChTy}{C}{\PrTy}$.
%\end{proof}
%\end{lemma}

%\begin{lemma}[Parallel Reduction]
%If $\Config{\Names_1}{\Store}{\Procs_1} -> \Config{\Names_2}{\Store}{\Procs_2}$,
%then there exists $\Names_4 \supseteq \Names_3 \supseteq \Names_2$ such that $\Config{\Names_3}{\Store}{\Procs_1, \Procs_3} ->
%\Config{\Names_4}{\Store}{\Procs_2,\Procs_3}$.
%\begin{proof}
%  By structural induction on the derivation of
%  $\Config{\Names_1}{\Store}{\Procs_1} -> \Config{\Names_2}{\Store}{\Procs_2}$.
%\end{proof}
%\end{lemma}

%To state progress on configurations, we will make use of Lemma~\ref{lem:par},
%which allows a portion of a process pool $\pi$ to take a reduction step. \todo{Check}
%
%\begin{lemma}[Parallel Reduction]\label{lem:par}
%If $\Config{\Names_1}{\Store}{\Procs_1} -> \Config{\Names_2}{\Store}{\Procs_2}$,
%then there exists $\Config{\Names_3}{\Store}{\Procs_3}$ such that
%$\Config{\Names_1,\Names_3}{\Store}{\Procs_1, \Procs_3} ->
%\Config{\Names_2,\Names_3}{\Store}{\Procs_2,\Procs_3}$.
%\begin{proof}
%  By structural induction on the derivation of
%  $\Config{\Names_1}{\Store}{\Procs_1} -> \Config{\Names_2}{\Store}{\Procs_2}$.
%\end{proof}
%\end{lemma}

\begin{theorem}[Progress]
If $\JCty{\StTy}{\ChTy}{C}{\PrTy}$, then either $\JCterm{C}$ or there exists
$C'$ such that $\JCred{C}{C'}$.

%For all configurations $C$,
%channel typings~$\ChTy$,
%and process typings~$\PrTy$,
%%
%if $\JCty{\StTy}{\ChTy}{C}{\PrTy}$
%then 
%either $\JCterm{C}$,
%or $\exists C'$ such that $\JCred{C}{C'}$.
\begin{proof}
    By structural induction on the derivation of
    $\JCty{\StTy}{\ChTy}{C}{\PrTy}$.
    \begin{itemize}[leftmargin=*]
    \item[] \textbf{Case}
      \begin{mathpar}
      \Infer{empty}
      { 
        %\StTy ; \ChTy |- \Store : \StTy
      }
      {\JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\emptyProcs}}{\cdot}}
      \end{mathpar}
      \begin{llproof}
        %\Pf{\ChTy}{|-}{{\Config{\Names}{\Store}{\emptyProcs}}: \cdot}{By
        %assumption}
        \Pf{}{}{\forall (p:e) \in \emptyProcs.~\Lterm{e}}{Vacuous}
        \Pf{}{}{\Sigma_1 = \textrm{RdChans}(\emptyProcs)=\emptyctxt}{By definition of RdChans}
        \Pf{}{}{\Sigma_2 = \textrm{WrChans}(\emptyProcs)=\emptyctxt}{By definition of
          WrChans}
        \Pf{}{}{\{ (c_1,c_2) \mid c_1 \in \Sigma_1, c_2 \in \Sigma_2, c_2 \leadsto c_1\} = \varnothing}{}        
        \Pf{}{}{\JCterm{{\Config{\Names}{\Store}{\emptyProcs}}}}{By rule Cterm}
      \end{llproof}

    \item[] \textbf{Case}
      \begin{mathpar}
      \Infer{cons}
      { \ChTy |- e : U\\
      \JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\Procs}}{\PrTy}}
      { \JCty{\StTy}{\ChTy}{\Config{\Names}{\Store}{\Procs,p:e}}{\PrTy,(p:U)}}
      \end{mathpar}
      
      \begin{llproof}
        \Pf{}{}{\Lterm{e}~\textrm{or}~\exists~e'~\textrm{s.t.}~e -> e'}{By i.h.}
        
        \Pf{}{}{\JCterm{\Config{\Names}{\Store}{\Procs}}~\textrm{or}~\exists
          \Config{\Names'}{\Store}{\Procs'}~\textrm{s.t.}~\Config{\Names}{\Store}{\Procs}
          -> \Config{\Names'}{\Store}{\Procs'}}{By i.h.}

        \Pf{}{}{\textbf{Subcase}~\exists~e'~\textrm{s.t.}~e -> e'}{}

        \Pf{}{}{\quad\textbf{Subsubcase}~\textrm{local}}{}

        \Pf{}{}{\qquad e = E[e_1]~\textrm{and}~e'= E[e_2]}{Suppose}        
        
        \Pf{}{}{\qquad \Config{\Names}{\Store}{\Procs,p:E[e_1]} ->
          \Config{\Names}{\Store}{\Procs,p:E[e_2]}}{By rule local}

        \Pf{}{}{\quad\textbf{Subsubcase}~\textrm{fork}}{}

        \Pf{}{}{\qquad e = E[\eFork{e_1}{e_2}],~e'= E[e_2],~\textrm{and}~q \not \in
          \Names}{Suppose}
        
        \Pf{}{}{\qquad \Config{\Names}{\Store}{\Procs,p:E[\eFork{e_1}{e_2}]} ->
          \Config{\Names,q}{\Store}{\Procs,q:e_1,p:E[e_2]}}{By rule fork}

        \Pf{}{}{\quad\textbf{Subsubcase}~\textrm{nu}}{}

        \Pf{}{}{\qquad e = E[\eNu{(x_1, x_2)}{e_1}],~e'= E[
            [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e_1 ],~c_1,c_2 \not \in
          \Names,~\textrm{and}~c_2 \leadsto c_1}{Suppose}
        
        \Pf{}{}{\qquad \Config{\Names}{\Store}{\Procs,p:[\eNu{(x_1, x_2)}{e_1}]} ->
          \Config{\Names, c_1, c_2}{\Store}{\Procs, \ProcNm{p} \proc{E[
                [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e_1 ]}}}{By rule nu}

        \Pf{}{}{\quad\textbf{Subsubcase}~\textrm{rw}}{}

        \Pf{}{}{\qquad e = E[ \eLetRd{\eChan{c_1}}{x}{e_1} ],~e'=E[
            [\ePair{!v}{\eChan{c_1}}{1}/x]e_1],~\textrm{and}~c_2 \leadsto
          c_1,~\textrm{or}}{}
        \Pf{}{}{\qquad\quad e = E[ \eWr{v}{\eChan{c_2}}],~e'=E[ \eUnit ],~\textrm{and}~c_2 \leadsto
          c_1}{}

        \Pf{}{}{\qquad \textbf{Subsubsubcase}~e = E[ \eLetRd{\eChan{c_1}}{x}{e_1}
          ],~e'=E[ [\ePair{!v}{\eChan{c_1}}{1}/x]e_1],~\textrm{and}~c_2 \leadsto c_1}{}

        \Pf{}{}{\qquad\quad \exists~(\ProcNm{q} E[ \eWr{v}{\eChan{c_2}}]) \in \pi}{By $c_2 \leadsto c_1$}

        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[
              \eLetRd{\eChan{c_1}}{x}{e_1} ]
        -> \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[
            [\ePair{!v}{\eChan{c_1}}{1}/x]e_1]}}}{By rule rw}

        \Pf{}{}{\qquad \textbf{Subsubsubcase}~e = E[ \eWr{v}{\eChan{c_2}}],~e'=E[
            \eUnit ],~\textrm{and}~c_2 \leadsto c_1}{}

        \Pf{}{}{\qquad\quad \exists~(\ProcNm{q} E[ \eLetRd{\eChan{c_1}}{x}{e_1} ]) \in \pi}{By $c_2 \leadsto c_1$}

        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[ \eWr{v}{\eChan{c_2}}]
        -> \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[
            \eUnit ]}}}{By rule rw}

        \Pf{}{}{\quad\textbf{Subsubcase}~\textrm{cw}}{}

        \Pf{}{}{\qquad e = E[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}],~e'=E[ [\ePair{!v}{c_i,
          c_{3-i}}{1}/x_i]e_{i}],~c \leadsto c_i,~i \in \{1, 2\},~\textrm{or}}{}
        \Pf{}{}{\qquad\quad e = E[ \eWr{v}{\eChan{c}}],~e'=E[ \eUnit ],~c \leadsto c_i,~i \in \{1, 2\}}{}

        \Pf{}{}{\qquad \textbf{Subsubsubcase}~e =
          E[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}],~e'=E[ [\ePair{!v}{c_i,
                c_{3-i}}{1}/x_i]e_{i}],}{}
        \Pf{}{}{\qquad\qquad c \leadsto c_i,~i \in \{1, 2\}}{}

        \Pf{}{}{\qquad\quad \exists~(\ProcNm{q} E[ \eWr{v}{\eChan{c}}]) \in \pi}{By $c \leadsto c_i$}

        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p}
            E[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}] ->
            \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[ [\ePair{!v}{c_i,
                    c_{3-i}}{1}/x_i]e_{i}]}}}{By rule cw}

        \Pf{}{}{\qquad \textbf{Subsubsubcase}~e = E[ \eWr{v}{\eChan{c}}],~e'=E[
            \eUnit ],~c \leadsto c_i,~i \in \{1, 2\}}{}

        \Pf{}{}{\qquad\quad \exists~(\ProcNm{q} E[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}]) \in
          \pi}{By $c \leadsto c_i$}

        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[ \eWr{v}{\eChan{c}}]
        -> \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[
            \eUnit ]}}}{By rule cw}        

        \Pf{}{}{\textbf{Subcase}~\exists
          \Config{\Names'}{\Store}{\Procs'}~\textrm{s.t.}~\Config{\Names}{\Store}{\Procs}
          -> \Config{\Names'}{\Store}{\Procs'}}{}
        
        \Pf{}{}{\quad\Config{\Names}{\Store}{\Procs,p:e} ->
          \Config{\Names'}{\Store}{\Procs',p:e}}{By rules local and congr}

\Pf{}{}{\textbf{Subcase}~\JCterm{\Config{\Names}{\Store}{p:e}}~\textrm{and}~\JCterm{\Config{\Names}{\Store}{\Procs}}}{}
        \Pf{}{}{\quad\Names_1 = \textrm{RdChans}(\Procs,p:e)~\textrm{and}~\Names_2 = \textrm{WrChans}(\Procs,p:e)}{Suppose}
        \Pf{}{}{\quad\{ (c_1,c_2) \mid c_1 \in \Names_1,
          c_2 \in \Names_2, c_2 \leadsto c_1\} =
          \varnothing~\textrm{or}}{}
        \Pf{}{}{\qquad\{ (c_1,c_2) \mid c_1 \in \Names_1,
          c_2 \in \Names_2, c_2 \leadsto c_1\} \neq
          \varnothing}{}
        \Pf{}{}{\quad\textbf{Subsubcase}~\{ (c_1,c_2) \mid c_1 \in \Names_1,
          c_2 \in \Names_2, c_2 \leadsto c_1\} =
          \varnothing}{}
        \Pf{}{}{\qquad\JCterm{\Config{\Names}{\Store}{\Procs,p:e}}}{By rule Cterm}
        \Pf{}{}{\quad\textbf{Subsubcase}~\{ (c_1,c_2) \mid c_1 \in \Names_1,
          c_2 \in \Names_2, c_2 \leadsto c_1\} \neq
          \varnothing}{}
        \Pf{}{}{\qquad \exists~c_2 \leadsto c_1~\textrm{s.t.}~c_1 \in \Sigma_1,
          c_2 \in \Sigma_2}{Above}
        
        \Pf{}{}{\qquad\ProcNm{p} v~\textrm{or}~\ProcNm{p} E[ \eLetRd{\eChan{c_1}}{x}{e}
          ]~\textrm{or}~\ProcNm{p}
          E[\eChoicee{c_1}{x_1}{e_1}{c_3}{x_2}{e_2}]~\textrm{or}}{}
        \Pf{}{}{\qquad\quad\ProcNm{p}
          E[\eChoicee{c_3}{x_1}{e_1}{c_1}{x_2}{e_2}]~\textrm{or}~\ProcNm{p} E[
            \eWr{v}{\eChan{c_2}}]}{By definition of \textbf{lterm}}

        \Pf{}{}{\qquad\textbf{Subsubsubcase}~\ProcNm{p} v}{Impossible}

        \Pf{}{}{\qquad\textbf{Subsubsubcase}~\ProcNm{p} E[ \eLetRd{\eChan{c_1}}{x}{e}
        ]}{}

        \Pf{}{}{\qquad\quad\exists~\ProcNm{q} E[ \eWr{v}{\eChan{c_2}}] \in \pi}{By $c_2 \leadsto c_1$}
        
        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[
                \eLetRd{\eChan{c_1}}{x}{e} ]} --->
          \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[
              [\ePair{!v}{\eChan{c_1}}{1}/x]e]}}{By rule rw}

        \Pf{}{}{\qquad\textbf{Subsubsubcase}~\ProcNm{p}
          E[\eChoicee{c_1}{x_1}{e_1}{c_3}{x_2}{e_2}]}{}

        \Pf{}{}{\qquad\quad\exists~\ProcNm{q} E[ \eWr{v}{\eChan{c_2}}] \in \pi}{By $c_2 \leadsto c_1$}        

        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p}
          E[\eChoicee{c_1}{x_1}{e_1}{c_3}{x_2}{e_2}]} --->
          \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[ [\ePair{!v}{c_1,
                  c_{3}}{1}/x_1]e_{1}]}}{By rule cw}


        \Pf{}{}{\qquad\textbf{Subsubsubcase}~\ProcNm{p}
          E[\eChoicee{c_3}{x_1}{e_1}{c_1}{x_2}{e_2}]}{}

        \Pf{}{}{\qquad\quad\exists~\ProcNm{q} E[ \eWr{v}{\eChan{c_2}}] \in \pi}{By $c_2 \leadsto c_1$}        

        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p}
          E[\eChoicee{c_3}{x_1}{e_1}{c_1}{x_2}{e_2}]} --->
          \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[ [\ePair{!v}{c_1,
          c_3}{1}/x_2]e_{2}]}}{By rule cw}        

        \Pf{}{}{\qquad\textbf{Subsubsubcase}~\ProcNm{p} E[
            \eWr{v}{\eChan{c_2}}]}{}

        \Pf{}{}{\qquad\quad\exists~\ProcNm{q} E[ \eLetRd{\eChan{c_1}}{x}{e}
          ] \in \pi~\textrm{or}~\exists~\ProcNm{q}
          E[\eChoicee{c_1}{x_1}{e_1}{c_3}{x_2}{e_2}] \in \pi~\textrm{or}}{}
        \Pf{}{}{\qquad\qquad\exists~\ProcNm{q}
          E[\eChoicee{c_3}{x_1}{e_1}{c_1}{x_2}{e_2}] \in \pi}{By $c_2 \leadsto c_1$}        
        
        \Pf{}{}{\qquad\quad\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[
              \eWr{v}{\eChan{c_2}}]} --->
          \Config{\Names}{\Store}{\Procs, \ProcNm{p} E[ \eUnit ]}}{By rule rw}
      \end{llproof}
    \end{itemize}    
\end{proof}  
\end{theorem}

\subsection{Preservation}

Preservation for the functional fragment of ILC (local preservation) is standard.

\begin{lemma}[Local Preservation]\label{lem:local-preservation}
  If $|- e : U$ and $e -> e'$, then $|- e' : U$.
  \begin{proof}
    By structural induction on the derivation of $e -> e'$.
  \end{proof}
\end{lemma}

To state preservation on configurations, we first state several auxiliary
results, which follow the formulation of Gay and
Vasconcelos~\cite{gay2010linear}.  Lemma~\ref{lem:equiv} shows that typing of
configurations is preserved under configuration equivalence.

\begin{lemma}[Preservation Modulo Equivalence]\label{lem:equiv}
  If $\ChTy |- C : \PrTy$ and $C \equiv C'$, then $\ChTy |- C' : \PrTy$.
  \begin{proof}
    By structural induction on $\ChTy |- C : \PrTy$.
  \end{proof}
\end{lemma}

Lemma~\ref{lem:subterms} shows that a subterm of a well-typed evaluation context
is typeable with a subset of the type contexts. 

\begin{lemma}[Typeability of Subterms]\label{lem:subterms}
  If $\mathcal{D}$ is a derivation of $\Delta; \Gamma |- E[e] : U$ (written $\mathcal{D}
  :: \Delta;\Gamma |- E[e] : U$), then
  \begin{enumerate}
    \item there exists $\Delta_1, \Delta_2, \Gamma_1,\Gamma_2$ and $V$ such that $\Delta = \Delta_1,\Delta_2$, $\Gamma =
      \Gamma_1,\Gamma_2$,
    \item $\mathcal{D}$ has a subderivation $\mathcal{D}'$ (written
      $\mathcal{D}' \sqsubseteq \mathcal{D}$) concluding $\Delta_1;\Gamma_1 |- e : V$,
    \item the position of $\mathcal{D}'$ in $\mathcal{D}$ corresponds to the
      position of the hole in $E$ (written $E[\mathcal{D}' \sqsubseteq \mathcal{D}]$).
  \end{enumerate}
  \begin{proof}
    By structural induction on the structure of $E$.
  \end{proof}
\end{lemma}

%\begin{lemma}[Typeability of Subterms]\label{lem:subterms}
%  If $|- E[e] : U$, then there exists a type $X$ (respectively, a type $A$) such
%  that $x : X; \emptyctxt |- E[x] : U$ and $|- e : X$ (respectively, such that
%  $\emptyctxt; x : A |- E[x] : U$ and $|- e : A$).
%  \begin{proof}
%    By structural induction on the structure of $E$.
%  \end{proof}
%\end{lemma}

Lemma~\ref{lem:replacement} shows that the subterm of a well-typed evaluation
context can be replaced.

%\begin{lemma}[Replacement (Evaluation Contexts)]\label{lem:replacement}
%  If
%  \begin{enumerate}
%  \item $\mathcal{D} :: \Delta_1,\Delta_2;\Gamma_1,\Gamma_2 |- E[e] : U$,
%  \item $\mathcal{D}' \sqsubseteq \mathcal{D}$ such that $\mathcal{D}' :: \Delta_2; \Gamma_2 |- e : V$,
%  \item $E[\mathcal{D}' \sqsubseteq \mathcal{D}]$,
%  \item $\Delta_3;\Gamma_3 |- e' : V$,
%  \item $\Delta_1,\Delta_3;\Gamma_1,\Gamma_3$ is defined,
%  \end{enumerate}
%  then $\Delta_1,\Delta_3;\Gamma_1,\Gamma_3 |- E[e'] : U$.
%  \begin{proof}
%    By structural induction on the structure of $E$.
%  \end{proof}  
%\end{lemma}

\begin{lemma}[Replacement (Evaluation Contexts)]\label{lem:replacement}
  If 
  \begin{enumerate}
  \item $\mathcal{D} :: \Delta_1,\Delta_2;\Gamma_1,\Gamma_2 |- E[e] : U$,
  \item $\mathcal{D}' \sqsubseteq \mathcal{D}$ such that $\mathcal{D}' :: \Delta_2; \Gamma_2 |- e : V$,
  \item $E[\mathcal{D}' \sqsubseteq \mathcal{D}]$,
  \item $\Delta_3;\Gamma_3 |- e' : V$,
  \item $\Delta_1,\Delta_3;\Gamma_1,\Gamma_3$ is defined,
  \end{enumerate}
  then $\Delta_1,\Delta_3;\Gamma_1,\Gamma_3 |- E[e'] : U$.
  \begin{proof}
    By structural induction on the structure of $E$.
  \end{proof}  
\end{lemma}

Finally, Lemmas~\ref{lem:sub-int} and~\ref{lem:sub-aff} show that typing of
terms is preserved by substitution.

\begin{lemma}[Substitution (Intuitionistic)]\label{lem:sub-int}
  If
  \begin{enumerate}
  \item $\Delta_1; \Gamma_1, x : A |- e : U$,
  \item $\Delta_2; \Gamma_2 |- e' : A$,
  \item $\Delta_1,\Delta_2 ; \Gamma_1,\Gamma_2$ is defined,
  \end{enumerate}
  then $\Delta_1,\Delta_2; \Gamma_1,\Gamma_2 |- [e'/x]e : U$.
  \begin{proof}
    By structural induction on the derivation of $\Delta_1; \Gamma_1, x : A |- e : U$.
  \end{proof}
\end{lemma}

\begin{lemma}[Substitution (Affine)]\label{lem:sub-aff}
  If
  \begin{enumerate}
  \item $\Delta_1, x : X; \Gamma_1 |- e : U$,
  \item $\Delta_2; \Gamma_2 |- e' : X$,
  \item $\Delta_1,\Delta_2 ; \Gamma_1,\Gamma_2$ is defined,
  \end{enumerate}
  then $\Delta_1,\Delta_2; \Gamma_1,\Gamma_2 |- [e'/x]e : U$.
  \begin{proof}
    By structural induction on the derivation of $\Delta_1, x : X; \Gamma_1 |- e : U$.
  \end{proof}
\end{lemma}

\begin{theorem}[Preservation]
If $\JCty{\StTy}{\ChTy}{C}{\PrTy}$ and $\JCred{C}{C'}$, then there exists
$\ChTy' \supseteq \ChTy$ and $\PrTy' \supseteq \PrTy$ such that
$\JCty{\StTy'}{\ChTy'}{C'}{\PrTy'}$.
\begin{proof}
    By structural induction on the derivation of $\JCred{C}{C'}$.
  \begin{itemize}[leftmargin=*]
  \item[] \textbf{Case}
    \begin{mathpar}
      \Infer{local}{e_1 ---> e_2 }
      { \Config{\Names}{\Store_1}{\Procs, \ProcNm{p} \proc{E[e_1]}} --->
        \Config{\Names}{\Store_2}{\Procs, \ProcNm{p} \proc{E[e_2]}} }
    \end{mathpar}
    \begin{llproof}
      \Pf{\ChTy}{|-}{\Config{\Names}{\Store_1}{\Procs, \ProcNm{p} \proc{E[e_1]}}
        : \PrTy~\textrm{s.t.}~\PrTy_{\pi} = \{ \PrTy(x) \mid (x:e) \in \pi\}~\textrm{and}}{}
      \Pf{}{}{\quad \mathcal{D} :: \Delta_1,\Delta_2;\Gamma_1,\Gamma_2|- E[e_1] : (U_{p} =
        \PrTy(p))}{Assumption}

      \Pf{}{}{\exists~\mathcal{D}'\sqsubseteq\mathcal{D}~\textrm{s.t.}~\mathcal{D}' :: \Delta_2;\Gamma_2|-
        e_1 : U~\textrm{and}~E[\mathcal{D}'\sqsubseteq\mathcal{D}]}{By
        Lemma~\ref{lem:subterms}}

      \Pf{\Delta_2; \Gamma_2}{|-}{e_2 : U}{By i.h. and Lemma~\ref{lem:local-preservation}}

      \Pf{\Delta_1,\Delta_2; \Gamma_1,\Gamma_2}{|-}{E[e_2] : U_p}{By Lemma~\ref{lem:replacement}}

      %\Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs} : \PrTy_{\pi}}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} \proc{E[e_2]}} : p :
        U_p}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[e_2]} :
        (\PrTy_{\pi}, p : U_p)}{By rule cons}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[e_2]} :
        \PrTy}{Above}      
      
      \Pf{}{}{\ChTy' = \ChTy~\textrm{and}~\PrTy' = \PrTy}{Suppose}

      \Pf{\ChTy'}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E[e_2]} :
        \PrTy'}{By above equalities}      
    \end{llproof}

  \item[] \textbf{Case}
    \begin{mathpar}
      \Infer{fork}{ q \notin \Names }
      { \Config{\Names}{\Store}{\Procs, \ProcNm{p} \proc{E[ \eFork{e_1}{e_2} }] } --->
        \Config{\Names,q}{\Store}{\Procs, \ProcNm{q} \proc{e_1}, \ProcNm{p} \proc{E[ e_2 ]}}}      
    \end{mathpar}
    \begin{llproof}
      \Pf{\ChTy}{|-}{\Config{\Names}{\Store_1}{\Procs, \ProcNm{p} \proc{E[\eFork{e_1}{e_2}]}}
        : \PrTy~\textrm{s.t.}~\PrTy_{\pi} = \{ \PrTy(x) \mid (x:e) \in \pi\}~\textrm{and}}{}
      \Pf{}{}{\quad \mathcal{D} :: \Delta_1,\Delta_2;\Gamma_1,\Gamma_2|- E[\eFork{e_1}{e_2}] : (U_{p} =
        \PrTy(p))}{Assumption}

      \Pf{}{}{\exists~\mathcal{D}'\sqsubseteq\mathcal{D}~\textrm{s.t.}~\mathcal{D}' :: \Delta_2;\Gamma_2|-
        \eFork{e_1}{e_2} : U~\textrm{and}~E[\mathcal{D}'\sqsubseteq\mathcal{D}]}{By
        Lemma~\ref{lem:subterms}}

      \Pf{\Delta_2; \Gamma_2}{|-}{e_2 : U}{By inversion on fork}

      \Pf{\Delta_1,\Delta_2; \Gamma_1,\Gamma_2}{|-}{E[e_2] : U_p}{By Lemma~\ref{lem:replacement}}

      \Pf{\Delta_2; \Gamma_2}{|-}{e_1 : U_q}{By inversion on fork}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs} : \PrTy_{\pi}}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names,q}{\Store}{\Procs} : \PrTy_{\pi}}{By $q \not \in
        \Sigma$}

%      \Pf{\ChTy}{|-}{\Config{\Names,q}{\Store}{\ProcNm{p} \proc{E[e_2]}} : p :
%        U_p}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names,q}{\Store}{\Procs, \ProcNm{q} \proc{e_1}} : (\PrTy_{\pi},
        q : U_q)}{By rule cons}

      \Pf{\ChTy}{|-}{\Config{\Names,q}{\Store}{\Procs, \ProcNm{q} \proc{e_1},
          \ProcNm{p} \proc{E[e_2]}} : (\PrTy_{\pi}, q : U_q, p : U_p)}{By
        rule cons}

      \Pf{\ChTy}{|-}{\Config{\Names,q}{\Store}{\Procs, \ProcNm{q} \proc{e_1},
          \ProcNm{p} \proc{E[e_2]}} : \PrTy}{Above}            

      \Pf{}{}{\ChTy' = \ChTy~\textrm{and}~\PrTy' = \PrTy}{Suppose}

      \Pf{\ChTy'}{|-}{\Config{\Names,q}{\Store}{\Procs, \ProcNm{q} \proc{e_1},
          \ProcNm{p} \proc{E[e_2]}} : \PrTy'}{By above equalities}            
    \end{llproof}

  \item[] \textbf{Case}
    \begin{mathpar}
      \Infer{congr}{
      C_1 \equiv C_1' 
      \\
      C_1' ---> C_2'
      \\
      C_2' \equiv C_2
      }
      { C_1 ---> C_2 }
    \end{mathpar}
    \begin{llproof}
      \Pf{\ChTy}{|-}{C_1 : \PrTy}{Assumption}
      \Pf{}{}{C_1 \equiv C_1'}{Given}
      \Pf{\ChTy}{|-}{C_1' : \PrTy}{By Lemma~\ref{lem:equiv}}
      \Pf{}{}{\ChTy'\supseteq\ChTy~\textrm{and}~\PrTy'\supseteq\PrTy}{Suppose}
      \Pf{\ChTy'}{|-}{C_2' : \PrTy'}{By i.h.}
      \Pf{\ChTy'}{|-}{C_2 : \PrTy'}{By Lemma~\ref{lem:equiv}}
    \end{llproof}

  \item[] \textbf{Case}
    \begin{mathpar}
      \Infer{nu}{ c_1, c_2 \notin \Names \\ c_2 \leadsto c_1}
      { \Config{\Names}{\Store}{\Procs, \ProcNm{p} \proc{E[ \eNu{(x_1, x_2)}{e} ]}} --->
        \Config{\Names, c_1, c_2}{\Store}{\Procs, \ProcNm{p} \proc{E[ [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e ]}}}
    \end{mathpar}
    \begin{llproof}
      \Pf{\ChTy}{|-}{\Config{\Names}{\Store_1}{\Procs, \ProcNm{p} \proc{E[
              \eNu{(x_1, x_2)}{e} ]}} : \PrTy~\textrm{s.t.}~\PrTy_{\pi} = \{
        \PrTy(x) \mid (x:e) \in \pi\}~\textrm{and}}{}
      \Pf{}{}{\quad \mathcal{D} :: \Delta_1,\Delta_2;\Gamma_1,\Gamma_2|- \proc{E[ \eNu{(x_1, x_2)}{e} ]}
        : (U_{p} =
        \PrTy(p))}{Assumption}

      \Pf{}{}{\exists~\mathcal{D}'\sqsubseteq\mathcal{D}~\textrm{s.t.}~\mathcal{D}' :: \Delta_2;\Gamma_2|-
        \eNu{(x_1, x_2)}{e} : U~\textrm{and}~E[\mathcal{D}'\sqsubseteq\mathcal{D}]}{By
        Lemma~\ref{lem:subterms}}      

      \Pf{}{}{c_2 \leadsto c_1~\text{s.t.}~\ChTy(c_2) =
        \tyWr{S}~\textrm{and}~\ChTy(c_1) = \tyRd{S}}{Given}      

      \Pf{\Delta ; \Gamma_2, x_2 : \tyWr{S}}{|-}{e : U~\textrm{where}~\Delta=\Delta_2, x_1:
        \tyRd{S}}{By inversion on nu}

      \Pf{\emptyctxt;\emptyctxt}{|-}{c_1 : \tyRd{S}}{Above}

      \Pf{\emptyctxt;\emptyctxt}{|-}{c_2 : \tyWr{S}}{Above}

      \Pf{\Delta_2; \Gamma_2}{|-}{[\eChan{c_1}/x_1][\eChan{c_2}/x_2]e : U}{By
        Lemmas~\ref{lem:sub-int} and~\ref{lem:sub-aff}}

      \Pf{\Delta_1,\Delta_2; \Gamma_1,\Gamma_2}{|-}{\proc{E[ [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e ]}
        : U_p}{By Lemma~\ref{lem:replacement}}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs} : \PrTy_{\pi}}{Above}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} \proc{E[
%              [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e ]}} : p : U_p}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} \proc{E[
              [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e ]}} : (\PrTy_{\pi}, p : U_p)}{By
        rule cons}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p}
          \proc{E[ [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e ]}} : \PrTy}{Above}      

      \Pf{}{}{\ChTy' = \ChTy~\textrm{and}~\PrTy' = \PrTy}{Suppose}

      \Pf{\ChTy'}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p}
          \proc{E[ [\eChan{c_1}/x_1][\eChan{c_2}/x_2]e ]}} : \PrTy'}{By above equalities}      
    \end{llproof}    
    
  \item[] \textbf{Case}
    \begin{mathpar}
    \Infer{rw}
    { c_2 \leadsto c_1 }
    { \Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[ \eLetRd{\eChan{c_1}}{x}{e} ], \ProcNm{q} E_2[ \eWr{v}{\eChan{c_2}}]} --->
      \Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[ [\ePair{!v}{\eChan{c_1}}{1}/x]e], \ProcNm{q}
        E_2[ \eUnit ]} }
    \end{mathpar}
    \begin{llproof}
      \Pf{\ChTy}{|-}{\Config{\Names}{\Store_1}{\Procs, \ProcNm{p} E_1[
              \eLetRd{\eChan{c_1}}{x}{e} ], \ProcNm{q} E_2[
            \eWr{v}{\eChan{c_2}}]} : \PrTy~\textrm{s.t.}~\PrTy_{\pi} = \{
        \PrTy(x) \mid (x:e) \in \pi\},}{}
      \Pf{}{}{\quad \mathcal{D}_p :: \Delta_1,\Delta_1';\Gamma_1,\Gamma_1'|- \proc{E_1[
              \eLetRd{\eChan{c_1}}{x}{e} ]} : (U_{p} =
        \PrTy(p)),~\textrm{and}}{}
      \Pf{}{}{\quad \mathcal{D}_q :: \Delta_2,\Delta_2';\Gamma_2,\Gamma_2'|- \proc{E_2[
            \eWr{v}{\eChan{c_2}}]} : (U_{q} =
        \PrTy(q))}{Assumption}

      \Pf{}{}{\exists~\mathcal{D}_p'\sqsubseteq\mathcal{D}_p~\textrm{s.t.}~\mathcal{D}_p' :: \Delta_1';\Gamma_1'|-
        \eLetRd{\eChan{c_1}}{x}{e} : U_p'~\textrm{and}~E_1[\mathcal{D}_p'\sqsubseteq\mathcal{D}_p]}{By
        Lemma~\ref{lem:subterms}}

      \Pf{}{}{\exists~\mathcal{D}_q'\sqsubseteq\mathcal{D}_q~\textrm{s.t.}~\mathcal{D}_q' :: \Delta_2';\Gamma_2'|-
        \eWr{v}{\eChan{c_2}} : U_q'~\textrm{and}~E_2[\mathcal{D}_q'\sqsubseteq\mathcal{D}_q]}{By
        Lemma~\ref{lem:subterms}}      

      \Pf{}{}{c_2 \leadsto c_1~\text{s.t.}~\ChTy(c_2) =
        \tyWr{S}~\textrm{and}~\ChTy(c_1) = \tyRd{S}}{Given}

      \Pf{\Delta;\Gamma_1'}{|-}{e : U_p'~\textrm{where}~\Delta=\Delta_1',\wrtok,x :
        \tyTensor{\tyBang{S}}{\tyRd{S}}}{By inversion on rd}

      \Pf{\emptyctxt;\emptyctxt}{|-}{v : S}{By inversion on wr}

      \Pf{\emptyctxt,\emptyctxt}{|-}{\eBang{v} : \tyBang{S}}{By rule bang}

      \Pf{\emptyctxt,\emptyctxt}{|-}{\ePair{!v}{\eChan{c_1}}{1} :
        \tyTensor{\tyBang{S}}{\tyRd{S}}}{By rule apair}

      \Pf{\Delta_1',\wrtok;\Gamma_1'}{|-}{[\ePair{!v}{\eChan{c_1}}{1}/x]e : U_p'}{By
          Lemma~\ref{lem:sub-aff}}

      \Pf{\Delta_1,\Delta_1';\Gamma_1,\Gamma_1'}{|-}{E_1[ [\ePair{!v}{\eChan{c_1}}{1}/x]e] : U_p}{By
        Lemma~\ref{lem:replacement}}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs} : \PrTy_{\pi}}{Above}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} E_1[
%            [\ePair{!v}{\eChan{c_1}}{1}/x]e]} : p : U_p}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_1}}{1}/x]e]} : (\PrTy_{\pi}, p : U_p)}{By rule cons}

      \Pf{\Delta_2';\Gamma_2'}{|-}{\eUnit : \tyUnit }{By rule unit}

      \Pf{\Delta_2,\Delta_2';\Gamma_2,\Gamma_2'}{|-}{E_2[ \eUnit ] : U_q}{By
        Lemma~\ref{lem:replacement}}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} E_1[
%            [\ePair{!v}{\eChan{c_1}}{1}/x]e]} : (\PrTy_{\pi}, p : U_p)}{Above}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{q} E_2[ \eUnit ]} : q :
      %        U_q}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[ [\ePair{!v}{\eChan{c_1}}{1}/x]e], \ProcNm{q}
          E_2[ \eUnit ]} : (\PrTy_{\pi}, p:U_p, q:U_q)}{By rule cons}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[ [\ePair{!v}{\eChan{c_1}}{1}/x]e], \ProcNm{q}
        E_2[ \eUnit ]} : \PrTy}{Above}      

      \Pf{}{}{\ChTy' = \ChTy~\textrm{and}~\PrTy' = \PrTy}{Suppose}      
      
      \Pf{\ChTy'}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[ [\ePair{!v}{\eChan{c_1}}{1}/x]e], \ProcNm{q}
        E_2[ \eUnit ]} : \PrTy'}{By above inequalities}
    \end{llproof}

  \item[] \textbf{Case}
    \begin{mathpar}
    \Infer{cw}
    { c \leadsto c_i \\ i \in \{1, 2\} }
    { \Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}], \ProcNm{q} E_2[ \eWr{v}{\eChan{c}}]} --->
      \Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[ [\ePair{!v}{c_i,
              c_{3-i}}{1}/x_i]e_{i}], \ProcNm{q} E_2[ \eUnit ]} }      
    \end{mathpar}
    \begin{llproof}
      \Pf{\ChTy}{|-}{\Config{\Names}{\Store_1}{\Procs, \ProcNm{p}
          E_1[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}], \ProcNm{q} E_2[
            \eWr{v}{\eChan{c}}]} : \PrTy}{}
      \Pf{}{}{\quad\textrm{s.t.}~\PrTy_{\pi} = \{
        \PrTy(x) \mid (x:e) \in \pi\},}{}
      \Pf{}{}{\quad \mathcal{D}_p :: \Delta_1,\Delta_1';\Gamma_1,\Gamma_1'|-
        \proc{E_1[\eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2}]} : (U_{p} =
        \PrTy(p)),~\textrm{and}}{}
      \Pf{}{}{\quad \mathcal{D}_q :: \Delta_2,\Delta_2';\Gamma_2,\Gamma_2'|- \proc{E_2[
            \eWr{v}{\eChan{c}}]} : (U_{q} =
        \PrTy(q))}{Assumption}

      \Pf{}{}{\exists~\mathcal{D}_p'\sqsubseteq\mathcal{D}_p~\textrm{s.t.}~\mathcal{D}_p' :: \Delta_1';\Gamma_1'|-
        \eChoicee{c_1}{x_1}{e_1}{c_2}{x_2}{e_2} : U_p'~\textrm{and}~E_1[\mathcal{D}_p'\sqsubseteq\mathcal{D}_p]}{By
        Lemma~\ref{lem:subterms}}

      \Pf{}{}{\exists~\mathcal{D}_q'\sqsubseteq\mathcal{D}_q~\textrm{s.t.}~\mathcal{D}_q' :: \Delta_2';\Gamma_2'|-
        \eWr{v}{\eChan{c_2}} : U_q'~\textrm{and}~E_2[\mathcal{D}_q'\sqsubseteq\mathcal{D}_q]}{By
        Lemma~\ref{lem:subterms}}
      
      \Pf{}{}{c \leadsto c_1~\text{s.t.}~\ChTy(c) =
        \tyWr{S},~\ChTy(c_1) = \tyRd{S},~\ChTy(c_2) = \tyRd{T}~\textrm{or}}{}
      \Pf{}{}{\quad c \leadsto c_2~\text{s.t.}~\ChTy(c) =
        \tyWr{T},~\ChTy(c_2) = \tyRd{T},~\ChTy(c_1) = \tyRd{S}}{Given}

      \Pf{}{}{\textbf{Subcase}~c \leadsto c_1}{}      

      \Pf{\Delta;\Gamma_1'}{|-}{e : U_p'~\textrm{where}~\Delta = \Delta_1',\wrtok, x_1 :
        \tyTensor{\tyBang{S}}{\tyTensor{\tyRd{S}}{\tyRd{T}}}}{By
        inversion on choice}

      \Pf{\emptyctxt;\emptyctxt}{|-}{v : S}{By inversion on wr}

      \Pf{\emptyctxt,\emptyctxt}{|-}{\eBang{v} : \tyBang{S}}{By rule bang}

      \Pf{\emptyctxt,\emptyctxt}{|-}{\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1} :
        \tyTensor{\tyBang{S}}{\tyTensor{\tyRd{S}}{\tyRd{T}}}}{By rule apair}

      \Pf{\Delta_1',\wrtok;\Gamma_1'}{|-}{\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1 : U_p'}{By
          Lemma~\ref{lem:sub-aff}}

      \Pf{\Delta_1,\Delta_1';\Gamma_1,\Gamma_1'}{|-}{E_1[ [\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1] : U_p}{By
        Lemma~\ref{lem:replacement}}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs} : \PrTy_{\pi}}{Above}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} E_1[
%            [\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1]} : p : U_p}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1]} : (\PrTy_{\pi}, p :
        U_p)}{By rule cons}

      \Pf{\Delta_2';\Gamma_2'}{|-}{\eUnit : \tyUnit }{By rule unit}

      \Pf{\Delta_2,\Delta_2';\Gamma_2,\Gamma_2'}{|-}{E_2[ \eUnit ] : U_q}{By
        Lemma~\ref{lem:replacement}}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} E_1[
%            [\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1]} : (\PrTy_{\pi}, p : U_p)}{Above}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{q} E_2[ \eUnit ]} : q :
      %        U_q}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1], \ProcNm{q} E_2[
            \eUnit ]} : (\PrTy_{\pi}, p : U_p, q : U_q)}{By rule cons}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1], \ProcNm{q} E_2[
            \eUnit ]} : \PrTy}{Above}            

      \Pf{}{}{\ChTy' = \ChTy~\textrm{and}~\PrTy' = \PrTy}{Suppose}      
      
      \Pf{\ChTy'}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_1},\eChan{c_2}}{1}/x_1]e_1], \ProcNm{q} E_2[
            \eUnit ]} : \PrTy'}{By above inequalities}

      \Pf{}{}{\textbf{Subcase}~c \leadsto c_2}{}      

      \Pf{\Delta;\Gamma_1'}{|-}{e : U_p'~\textrm{where}~\Delta = \Delta_1',\wrtok, x_2 :
        \tyTensor{\tyBang{T}}{\tyTensor{\tyRd{T}}{\tyRd{S}}}}{By
        inversion on choice}

      \Pf{\emptyctxt;\emptyctxt}{|-}{v : T}{By inversion on wr}

      \Pf{\emptyctxt,\emptyctxt}{|-}{\eBang{v} : \tyBang{T}}{By rule bang}

      \Pf{\emptyctxt,\emptyctxt}{|-}{\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1} :
        \tyTensor{\tyBang{T}}{\tyTensor{\tyRd{T}}{\tyRd{S}}}}{By rule apair}

      \Pf{\Delta_1',\wrtok;\Gamma_1'}{|-}{\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2 : U_p'}{By
          Lemma~\ref{lem:sub-aff}}

      \Pf{\Delta_1,\Delta_1';\Gamma_1,\Gamma_1'}{|-}{E_1[ [\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2] : U_p}{By
        Lemma~\ref{lem:replacement}}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs} : \PrTy_{\pi}}{Above}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} E_1[
%            [\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2]} : p : U_p}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2]} : (\PrTy_{\pi}, p :
        U_p)}{By rule cons}

      \Pf{\Delta_2';\Gamma_2'}{|-}{\eUnit : \tyUnit }{By rule unit}

      \Pf{\Delta_2,\Delta_2';\Gamma_2,\Gamma_2'}{|-}{E_2[ \eUnit ] : U_q}{By
        Lemma~\ref{lem:replacement}}

%      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{p} E_1[
%            [\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2]} : \PrTy_{\pi}, p : U_p}{Above}

 %     \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\ProcNm{q} E_2[ \eUnit ]} : q :
      %       U_q}{Above}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2], \ProcNm{q} E_2[
            \eUnit ]} : (\PrTy_{\pi}, p : U_p, q : U_q)}{By rule cons}

      \Pf{\ChTy}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2], \ProcNm{q} E_2[
            \eUnit ]} : \PrTy}{Above}      

      \Pf{}{}{\ChTy' = \ChTy~\textrm{and}~\PrTy' = \PrTy}{Suppose}      
      
      \Pf{\ChTy'}{|-}{\Config{\Names}{\Store}{\Procs, \ProcNm{p} E_1[
            [\ePair{!v}{\eChan{c_2},\eChan{c_1}}{1}/x_2]e_2], \ProcNm{q} E_2[
            \eUnit ]} : \PrTy'}{By above inequalities}
    \end{llproof}    
  \end{itemize}
\end{proof}
\end{theorem}

\section{Confluence}

The following lemmas state structural invariants over write effects and read
channels of a well-typed configuration: at most one process owns the write token
$\wrtok$, and every read channel end is a non-duplicable (affine) resource.

%\begin{lemma}[Unique writer process]
%\label{lem:UniqueWriter}
%If $C$ is a well-typed configuration with process pool~$\pi$, 
%then there exists at most one write-mode process in $\pi$.
%\begin{proof}
%By structural induction over the typing derivation for $C$.
%\end{proof}
%\end{lemma}

\begin{lemma}[Unique writer process]
\label{lem:UniqueWriter}
If $C$ is a well-typed configuration with process pool~$\pi$, then there exists at
most one process in $\pi$ that owns the write token $\wrtok$ (i.e., has $\wrtok$
in its affine context).
\begin{proof}
By structural induction over the typing derivation for $C$.
\end{proof}
\end{lemma}

\begin{lemma}[Unique reader process]
\label{lem:UniqueReader}
If $C$ is a well-typed configuration with process pool~$\pi$, 
and $c$ is a read channel in this configuration,
then there exists at most one process in $\pi$ where $c$ appears.
\begin{proof}
By structural induction over the typing derivation for $C$.
\end{proof}
\end{lemma}

\begin{theorem}[Single-step confluence]\label{lem:single-step-confluence}
For all well-typed configurations $C$,
%
 if $\JCred{C}{C_1}$ 
and $\JCred{C}{C_2}$ 
then 
there exists renaming a function~$f$ 
such that either:
\begin{enumerate}
\item %$\JCterm{C_1}$ and 
$C_1 = f(C_2)$,
or
\item there exists $C_3$ such that $\JCred{C_1}{C_3}$ and $\JCred{f(C_2)}{C_3}$.
\end{enumerate}
\begin{proof}
   By induction on the pair of steps 
   $\left< \JCred{C}{C_1}\right.$, 
   $\left.\JCred{C}{C_2} \right>$.

   We consider the following cases:
   \begin{itemize}[leftmargin=*]
   \item[] \textbf{Case} congruence
     \begin{itemize}[leftmargin=*]
       \item[] If either step uses \Rule{congr}, we apply
     the inductive hypothesis.
     \end{itemize}     

   \item[] \textbf{Case} independent processes
     \begin{itemize}[leftmargin=*]
       \item[] If both steps advance distinct processes, using any of the rules
         \Rule{local}, \Rule{fork} and \Rule{nu}, we produce $C_3$ by combining
         those two (independent) steps.
     \end{itemize}


   \item[] \textbf{Case} one process
     \begin{itemize}[leftmargin=*]
       \item[] If both steps advance the same process, we show that this is
         deterministic (up to naming) by constructing the naming function $f$
         such that $C_2 = f(C_1)$.  Most cases are straightforward since they
         perform no nondeterministic choices.  The only source of nondeterminism
         is the name choices, in rules \Rule{nu} and \Rule{fork}. In each case,
         we map the name choice from the second step to that of the first step.
     \end{itemize}

   \item[] \textbf{Case} interaction
     \begin{itemize}[leftmargin=*]
       \item[] If either step uses \Rule{rw} or \Rule{cw}, we rely on Lemmas
         \ref{lem:UniqueWriter} and \ref{lem:UniqueReader} to show that both
         steps use either \Rule{rw} or \Rule{cw}, and that the reader-writer
         process pair is unique.
     \end{itemize}
   \end{itemize}
\end{proof}
\end{theorem}

By composing multiple uses of this theorem
we prove multi-step confluence.
However, to carry forth this composition, we need a more general
notion of single-step confluence, which is parameteric in a renaming
function for the initial configurations.

\begin{theorem}[Single-step confluence, generalized]
For all well-typed configurations $C$ 
and renaming functions $f$,
%
 if $\JCred{C}{C_1}$ 
and $\JCred{f(C)}{C_2}$ 
then 
there exists renaming function~$g$ 
such that either:
\begin{enumerate}
\item %$\JCterm{C_1}$ and 
$C_1 = g(C_2)$,
or
\item there exists $C_3$ such that $\JCred{C_1}{C_3}$ and $\JCred{g(C_2)}{C_3}$.
\end{enumerate}
\begin{proof}
  Analogous to the proof of Theorem~\ref{lem:single-step-confluence}
  (single-step confluence).
\end{proof}
\end{theorem}

We prove a full confluence theorem that is generalized similarly, by
accepting a renaming function~$f$ to produce a new function~$g$:

\begin{theorem}[Full confluence]
For all well-typed configurations $C$,
and renaming functions $f$,
%
 if $\JCredm{C}{C_1}$ 
and $\JCredm{f(C)}{C_2}$ 
and $\JCterm{C_1}$
and $\JCterm{C_2}$
then 
there exists a renaming function~$g$ 
such that $C_1 = g(C_2)$.
\begin{proof}
  By induction on the reduction sequence pair
  $\left< \JCredm{C}{C_1}\right.$, 
  $\left.\JCredm{f(C)}{C_2} \right>$.
  Because of single-step confluence, we know that
  if either reduction sequence is empty, then the other must be empty,
  and that
  if either takes a step, the other must take a step.

   \begin{itemize}[leftmargin=*]
   \item[] \textbf{Case} empty
     \begin{itemize}[leftmargin=*]
       \item[] When empty, we have the resulting renaming function~$g$ via
         single-step confluence.
     \end{itemize}

   \item[] \textbf{Case} step
     \begin{itemize}[leftmargin=*]
       \item[] We consider the case where each reduction consists of at least
         one step: $\JCred{C}{C_1'}$ and $\JCredm{C_1'}{C_1}$ and
         $\JCred{f(C)}{C_2'}$ and $\JCredm{C_2'}{C_2}$.  By single-step
         confluence, we have that there exists $g_0$ such that $g_0(C_2') =
         C_1'$.  By the inductive hypothesis, we have that there exists $g$ such
         that $C_1 = g(C_2)$.
     \end{itemize}     
   \end{itemize}
\end{proof}
\end{theorem}
