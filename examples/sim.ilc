{- TODO: Shadowing variables not working properly and fix reference cells. -}
let sim k bits =
  let! k' = k in
  let! bits' = bits in
  let (bs0,bits'') = splitAt 4 bits' in
  let (pk0,td0) = kgen bs0 in
  let (bs1,bits''') = splitAt 4 bits'' in
  let (pk1,td1) = kgen bs1 in
  let (r0,bits'''') = splitAt 4 bits''' in
  let (r1,bits''''') = splitAt 4 bits'''' in
  let sigma = xors (prg pk0 r0) (prg pk1 r1) in
  print sigma
